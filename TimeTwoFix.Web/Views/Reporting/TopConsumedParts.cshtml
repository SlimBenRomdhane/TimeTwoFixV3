@model IEnumerable<TimeTwoFix.Web.Models.ReportingModels.PartConsumptionViewModel>

@{
    ViewData["Title"] = "Spare Parts Consumption";
}

<h2>Spare Parts Consumption</h2>



<!-- Date filter form -->
<form asp-action="TopConsumedParts" method="get" class="row g-3 mb-3">
    <div class="col-auto">
        <label for="from" class="form-label">From</label>
        <input type="date" id="from" name="from" class="form-control" value="@ViewData["From"]" />
    </div>
    <div class="col-auto">
        <label for="to" class="form-label">To</label>
        <input type="date" id="to" name="to" class="form-control" value="@ViewData["To"]" />
    </div>
    <div class="col-auto align-self-end">
        <button type="submit" class="btn btn-primary">Filter</button>
    </div>
</form>

@if (Model != null && Model.Any())
{
    <!-- Data table -->
    <table class="table table-striped">
        <thead>
            <tr>
                <th>Part Code</th>
                <th>Part Name</th>
                <th>Quantity Used</th>
                <th>Total Value (TND)</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var part in Model)
            {
                <tr>
                    <td>@part.PartCode</td>
                    <td>@part.PartName</td>
                    <td>@part.QuantityUsed</td>
                    <td>@part.TotalValue.ToString("N3")</td>
                </tr>
            }
        </tbody>
    </table>

    <!-- Chart selector -->
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>Visual Breakdown</h3>
        <select id="metricSelector" class="form-select w-auto">
            <option value="QuantityUsed" selected>Quantity Used</option>
            <option value="TotalValue">Total Value</option>
        </select>
    </div>

    <div class="chart-container">
        <canvas id="partsChart"></canvas>
    </div>

    @section Scripts {
        <script src="~/lib/chartjs/chart.min.js"></script>
        <script>
            const partData = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model));
            const partLabels = partData.map(p => p.PartName);

            function buildDataset(metric) {
                return [{
                    label: metric === "QuantityUsed" ? "Quantity Used" : "Total Value (TND)",
                    data: partData.map(p => p[metric]),
                    backgroundColor: metric === "QuantityUsed" ? "#00BFFF" : "#FF6347"
                }];
            }

            let partsChart = new Chart(document.getElementById('partsChart'), {
                type: 'bar',
                data: {
                    labels: partLabels,
                    datasets: buildDataset("QuantityUsed")
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: { display: true, text: "Quantity Used" }
                        },
                        x: {
                            title: { display: true, text: "Spare Part" }
                        }
                    }
                }
            });

            document.getElementById('metricSelector').addEventListener('change', function () {
                const metric = this.value;
                partsChart.data.datasets = buildDataset(metric);
                partsChart.options.scales.y.title.text = metric === "QuantityUsed" ? "Quantity Used" : "Total Value (TND)";
                partsChart.update();
            });
        </script>
    }
}
else
{
    <p>No data available for the selected range.</p>
}